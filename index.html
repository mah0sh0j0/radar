function updateRadarLayer(basetime, validtime) {
    if (!map) return;

    const now = new Date();
    const futureTime = new Date(
        parseInt(validtime.slice(0, 4)),
        parseInt(validtime.slice(4, 6)) - 1,
        parseInt(validtime.slice(6, 8)),
        parseInt(validtime.slice(8, 10)),
        parseInt(validtime.slice(10, 12))
    );

    // 現在の時刻が futureTime より1分以上経過していない場合はスキップ
    const oneMinuteAfterFutureTime = new Date(futureTime.getTime() + 60 * 1000);
    if (now.getTime() < oneMinuteAfterFutureTime.getTime()) {
        console.log("Skipping data until 1 minute after the valid time:", validtime);
        return;
    }

    const tileUrl = `https://www.jma.go.jp/bosai/jmatile/data/nowc/${basetime}/none/${validtime}/surf/hrpns/{z}/{x}/{y}.png`;

    const newRadarLayerId = `jma-radar-${Date.now()}`;

    // レーダーレイヤーを再読み込み
    map.addSource(newRadarLayerId, {
        type: 'raster',
        tiles: [tileUrl],
        tileSize: 256,
        maxzoom: 10
    });

    map.addLayer({
        id: newRadarLayerId,
        type: 'raster',
        source: newRadarLayerId
    });

    if (!currentLayer) {
        const maskUrl = `https://www.jma.go.jp/bosai/jmatile/data/map/none/none/none/surf/mask/{z}/{x}/{y}.png`;
        const newMaskLayerId = `jma-mask`;

        map.addSource(newMaskLayerId, {
            type: 'raster',
            tiles: [maskUrl],
            tileSize: 256,
            maxzoom: 10
        });

        map.addLayer({
            id: newMaskLayerId,
            type: 'raster',
            source: newMaskLayerId
        });

        currentLayer = {
            radar: newRadarLayerId,
            mask: newMaskLayerId
        };
    } else {
        if (map.getLayer(currentLayer.radar)) {
            map.removeLayer(currentLayer.radar);
        }
        if (map.getSource(currentLayer.radar)) {
            map.removeSource(currentLayer.radar);
        }

        currentLayer.radar = newRadarLayerId;
    }

    const validDateUTC = new Date(
        parseInt(validtime.slice(0, 4)),
        parseInt(validtime.slice(4, 6)) - 1,
        parseInt(validtime.slice(6, 8)),
        parseInt(validtime.slice(8, 10)),
        parseInt(validtime.slice(10, 12))
    );
    const validDateJST = new Date(validDateUTC.getTime() + 9 * 60 * 60 * 1000);
    const formattedDate = `${validDateJST.getFullYear()}年${(validDateJST.getMonth() + 1).toString().padStart(2, '0')}月${validDateJST.getDate().toString().padStart(2, '0')}日${validDateJST.getHours().toString().padStart(2, '0')}時${validDateJST.getMinutes().toString().padStart(2, '0')}分`;

    document.getElementById('time-display').innerText = formattedDate;
}
